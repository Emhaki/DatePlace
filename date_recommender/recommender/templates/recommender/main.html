<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>데이트 장소 추천</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #map {
            height: 500px;
            width: 100%;
        }
        .card {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">데이트 장소 추천</a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">지역 필터</h5>
                        <select id="region-filter" class="form-select">
                            <option value="">모든 지역</option>
                            <option value="서울">서울</option>
                            <option value="부산">부산</option>
                            <option value="대구">대구</option>
                            <option value="인천">인천</option>
                            <option value="광주">광주</option>
                            <option value="대전">대전</option>
                            <option value="울산">울산</option>
                        </select>
                    </div>
                </div>
                <div id="place-list" class="mt-4">
                    <!-- 장소 목록이 여기에 동적으로 추가됩니다 -->
                </div>
            </div>
            <div class="col-md-9">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap" async defer></script>
    <script>
        let map;
        let markers = [];
        const regionCoordinates = {
            '서울': {lat: 37.5665, lng: 126.9780},
            '부산': {lat: 35.1796, lng: 129.0756},
            '대구': {lat: 35.8714, lng: 128.6014},
            '인천': {lat: 37.4563, lng: 126.7052},
            '광주': {lat: 35.1601, lng: 126.8514},
            '대전': {lat: 36.3504, lng: 127.3845},
            '울산': {lat: 35.5384, lng: 129.3114},
        };

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: regionCoordinates['서울'],
                zoom: 11
            });
            loadPlaces();
        }

        function loadPlaces(region = '') {
            fetch(`/get_places/?region=${region}`)
                .then(response => response.json())
                .then(data => {
                    clearMarkers();
                    updatePlaceList(data.places);
                    data.places.forEach(place => {
                        const marker = new google.maps.Marker({
                            position: {lat: place.latitude, lng: place.longitude},
                            map: map,
                            title: place.name
                        });

                        const infoWindow = new google.maps.InfoWindow({
                            content: `<h5>${place.name}</h5>
                                      <p>카테고리: ${place.category}</p>
                                      <p>주소: ${place.address}</p>
                                      <p>${place.description}</p>`
                        });

                        marker.addListener('click', () => {
                            infoWindow.open(map, marker);
                        });

                        markers.push(marker);
                    });
                    if (region && regionCoordinates[region]) {
                        map.setCenter(regionCoordinates[region]);
                        map.setZoom(11);
                    } else {
                        fitMapToMarkers();
                    }
                });
        }

        function clearMarkers() {
            markers.forEach(marker => marker.setMap(null));
            markers = [];
        }

        function fitMapToMarkers() {
            if (markers.length > 0) {
                const bounds = new google.maps.LatLngBounds();
                markers.forEach(marker => bounds.extend(marker.getPosition()));
                map.fitBounds(bounds);
            }
        }

        function updatePlaceList(places) {
            const placeList = document.getElementById('place-list');
            placeList.innerHTML = '';
            places.forEach(place => {
                const placeCard = document.createElement('div');
                placeCard.className = 'card';
                placeCard.innerHTML = `
                    <div class="card-body">
                        <h5 class="card-title">${place.name}</h5>
                        <p class="card-text">${place.category}</p>
                        <button class="btn btn-primary btn-sm" onclick="focusPlace(${place.latitude}, ${place.longitude})">지도에서 보기</button>
                    </div>
                `;
                placeList.appendChild(placeCard);
            });
        }

        function focusPlace(lat, lng) {
            map.setCenter({lat: lat, lng: lng});
            map.setZoom(15);
        }

        document.getElementById('region-filter').addEventListener('change', function() {
            loadPlaces(this.value);
        });
    </script>
</body>
</html>
